{% extends 'base.html' %}
{%load static%}

{% block title %}Analytics Dashboard - SUPERDOLL IT Help Desk{% endblock %}

{% block extra_head %}
<style>
    .status-badge {
        font-size: 0.85rem;
        padding: 0.35em 0.65em;
    }
    .status-new { background-color: #3498db; color: white; }
    .status-open { background-color: #e67e22; color: white; }
    .status-in_progress { background-color: #f1c40f; color: black; }
    .status-resolved { background-color: #2ecc71; color: white; }
    .status-unresolved { background-color: #e74c3c; color: white; }
    .priority-badge {
        font-size: 0.85rem;
        padding: 0.35em 0.65em;
    }
    .priority-urgent { background-color: #d63031; color: white; }
    .priority-high { background-color: #e17055; color: white; }
    .priority-medium { background-color: #00b894; color: white; }
    .priority-low { background-color: #0984e3; color: white; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3 col-lg-2 sidebar p-0">
            <div class="p-3">
                <div class="text-center mb-4">
                    <i class="fas fa-gem fa-2x mb-2"></i>
                    <img src="{% static 'images/stm_logo.png' %}" alt="SUPERDOLL Logo" class="img-fluid">
                    <small>Analytics</small>
                </div>
                
                <nav class="nav flex-column">
                    <a class="nav-link" href="{% url 'admin_dashboard' %}">
                        <i class="fas fa-tachometer-alt me-2"></i>MAIN ADMIN DASHBOARD
                    </a>
                    <a class="nav-link active" href="{% url 'analytics_dashboard' %}">
                        <i class="fas fa-chart-line me-2"></i>Analytics
                    </a>
                    <a class="nav-link" href="{% url 'forecasting_dashboard' %}">
                        <i class="fas fa-crystal-ball me-2"></i>Forecasting
                    </a>
                    <a class="nav-link" href="{% url 'budget_management' %}">
                        <i class="fas fa-dollar-sign me-2"></i>Budget
                    </a>
                    <a class="nav-link" href="{% url 'ticket_list' %}">
                        <i class="fas fa-list me-2"></i>All Tickets
                    </a>
                    <a class="nav-link" href="{% url 'logout' %}">
                        <i class="fas fa-sign-out-alt me-2"></i>Logout
                    </a>
                </nav>
                
                <!-- <div class="mt-4 p-3 bg-light rounded text-dark">
                    <div class="moving-text small">
                        We don't grow when things are easy, we grow when we face challenges
                    </div>
                </div> -->
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-md-9 col-lg-10 ms-sm-auto px-md-4">
            <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                <h1 class="h2">
                    <i class="fas fa-chart-line me-2"></i>Analytics Dashboard
                </h1>
                <div class="btn-toolbar mb-2 mb-md-0">
                    <div class="btn-group me-2">
                        <button type="button" class="btn btn-outline-secondary" onclick="refreshAnalytics()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh
                        </button>
                        <button type="button" class="btn btn-success" onclick="exportAnalytics()">
                            <i class="fas fa-download me-1"></i>Export Report
                        </button>
                    </div>
                </div>
            </div>

            <!-- Key Metrics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="stat-number">{{ total_tickets }}</div>
                                <div>Total Tickets</div>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-ticket-alt fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card bg-info">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="stat-number">{{ tickets_last_30 }}</div>
                                <div>Last 30 Days</div>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-calendar-month fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card bg-warning">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="stat-number">{{ tickets_last_90 }}</div>
                                <div>Last 90 Days</div>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-calendar-alt fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card bg-success">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="stat-number">4.2</div>
                                <div>Avg Rating</div>
                            </div>
                            <div class="align-self-center">
                                <i class="fas fa-star fa-2x opacity-75"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row 1 -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-chart-pie me-2"></i>Priority Distribution
                            </h5>
                        </div>
                        <div class="card-body">
                            <canvas id="priorityChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-chart-bar me-2"></i>Response Time by Category
                            </h5>
                        </div>
                        <div class="card-body">
                            <canvas id="responseTimeChart" width="400" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row 2 -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-chart-line me-2"></i>Monthly Ticket Trends
                            </h5>
                        </div>
                        <div class="card-body">
                            <canvas id="trendsChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Category Performance -->
            <div class="row mb-4">
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-tags me-2"></i>Category Performance
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Category</th>
                                            <th>Total Tickets</th>
                                            <th>Open</th>
                                            <th>Resolved</th>
                                            <th>Resolution Rate</th>
                                            <th>Performance</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for category in category_stats %}
                                            <tr>
                                                <td><strong>{{ category.name }}</strong></td>
                                                <td>{{ category.total_tickets }}</td>
                                                <td>
                                                    <span class="status-badge status-open">{{ category.open_tickets }}</span>
                                                </td>
                                                <td>
                                                    <span class="status-badge status-resolved">{{ category.resolved_tickets }}</span>
                                                </td>
                                                <td>
                                                    {% if category.total_tickets > 0 %}
                                                        {{ category.resolved_tickets|floatformat:0 }}%
                                                    {% else %}
                                                        N/A
                                                    {% endif %}
                                                </td>
                                                <td>
                                                    <div class="progress" style="height: 20px;">
                                                        {% with resolution_rate=category.resolved_tickets|floatformat:0 %}
                                                        <div class="progress-bar 
                                                            {% if resolution_rate >= 80 %}bg-success
                                                            {% elif resolution_rate >= 60 %}bg-warning
                                                            {% else %}bg-danger{% endif %}" 
                                                            role="progressbar" 
                                                            style="width: {{ resolution_rate }}%"
                                                            aria-valuenow="{{ resolution_rate }}" 
                                                            aria-valuemin="0" 
                                                            aria-valuemax="100">
                                                            {{ resolution_rate }}%
                                                        </div>
                                                        {% endwith %}
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-smile me-2"></i>Customer Satisfaction
                            </h5>
                        </div>
                        <div class="card-body">
                            <canvas id="satisfactionChart" width="300" height="300"></canvas>
                            <div class="text-center mt-3">
                                <h4 class="text-success">4.2/5.0</h4>
                                <p class="text-muted">Average Rating</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Top Users -->
            <div class="row">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-users me-2"></i>Top Users by Ticket Volume
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                {% for user in top_users %}
                                    <div class="col-md-6 mb-3">
                                        <div class="d-flex align-items-center">
                                            <div class="me-3">
                                                <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" 
                                                     style="width: 40px; height: 40px;">
                                                    <i class="fas fa-user text-white"></i>
                                                </div>
                                            </div>
                                            <div class="flex-grow-1">
                                                <h6 class="mb-0">
                                                    {{ user.user__first_name|default:user.user__username }} 
                                                    {{ user.user__last_name }}
                                                </h6>
                                                <small class="text-muted">{{ user.ticket_count }} tickets</small>
                                            </div>
                                            <div>
                                                <span class="badge bg-primary">{{ user.ticket_count }}</span>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Priority Distribution Chart
const priorityCtx = document.getElementById('priorityChart').getContext('2d');
const priorityData = {{ priority_stats|safe }};
const priorityChart = new Chart(priorityCtx, {
    type: 'doughnut',
    data: {
        labels: priorityData.map(item => item.priority),
        datasets: [{
            data: priorityData.map(item => item.count),
            backgroundColor: ['#28a745', '#17a2b8', '#ffc107', '#dc3545']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Response Time Chart
const responseTimeCtx = document.getElementById('responseTimeChart').getContext('2d');
const responseTimeData = {{ response_times|safe }};
const responseTimeChart = new Chart(responseTimeCtx, {
    type: 'bar',
    data: {
        labels: responseTimeData.map(item => item.category),
        datasets: [{
            label: 'Avg Response Time (hours)',
            data: responseTimeData.map(item => item.avg_hours),
            backgroundColor: '#36A2EB'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                title: {
                    display: true,
                    text: 'Hours'
                }
            }
        }
    }
});

// Monthly Trends Chart
const trendsCtx = document.getElementById('trendsChart').getContext('2d');
const monthlyData = {{ monthly_trends|safe }};
const trendsChart = new Chart(trendsCtx, {
    type: 'line',
    data: {
        labels: monthlyData.map(item => item.month),
        datasets: [{
            label: 'Created',
            data: monthlyData.map(item => item.created),
            borderColor: '#FF6384',
            backgroundColor: 'rgba(255, 99, 132, 0.1)',
            tension: 0.4,
            fill: true
        }, {
            label: 'Resolved',
            data: monthlyData.map(item => item.resolved),
            borderColor: '#36A2EB',
            backgroundColor: 'rgba(54, 162, 235, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Satisfaction Chart
const satisfactionCtx = document.getElementById('satisfactionChart').getContext('2d');
const satisfactionData = {{ satisfaction_data|safe }};
const satisfactionChart = new Chart(satisfactionCtx, {
    type: 'doughnut',
    data: {
        labels: ['Excellent', 'Good', 'Average', 'Poor'],
        datasets: [{
            data: [satisfactionData.excellent, satisfactionData.good, satisfactionData.average, satisfactionData.poor],
            backgroundColor: ['#28a745', '#17a2b8', '#ffc107', '#dc3545']
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});

// Refresh function
function refreshAnalytics() {
    location.reload();
}

// Export function
function exportAnalytics() {
    // Implementation for exporting analytics report
    alert('Analytics report export feature coming soon!');
}

// Real-time updates
setInterval(function() {
    fetch('/api/analytics/?type=overview')
        .then(response => response.json())
        .then(data => {
            // Update real-time metrics
            console.log('Updated analytics data:', data);
        });
}, 30000); // Update every 30 seconds
</script>
{% endblock %}
